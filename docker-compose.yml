version: "3.9"

x-env: &default-env
  OPENAI_API_KEY: ${OPENAI_API_KEY}
  NODE_ENV: ${NODE_ENV:-development}
  PYTHONUNBUFFERED: "1"
  APP_BASE_URL: ${APP_BASE_URL:-http://localhost:3000}
  API_BASE_URL: ${API_BASE_URL:-http://api:8000}
  DATABASE_URL: postgresql+psycopg2://${POSTGRES_USER}:${POSTGRES_PASSWORD}@db:5432/${POSTGRES_DB}
  REDIS_URL: redis://redis:6379/0
  S3_ENDPOINT: http://minio:9000
  S3_REGION: ${S3_REGION:-us-east-1}
  S3_BUCKET: ${S3_BUCKET:-codex-suite}
  S3_ACCESS_KEY: ${MINIO_ROOT_USER}
  S3_SECRET_KEY: ${MINIO_ROOT_PASSWORD}

services:
  web:
    build:
      context: ./apps/web
      dockerfile: Dockerfile
    environment:
      <<: *default-env
      PORT: 3000
    depends_on: [api]
    ports: ["3000:3000"]
    volumes:
      - ./apps/web:/app
      - /app/node_modules
    command: npm run dev

  api:
    build:
      context: ./apps/api
    environment:
      <<: *default-env
      PORT: 8000
    depends_on: [db, redis, minio]
    ports: ["8000:8000"]
    volumes:
      - ./apps/api:/app
    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

  worker:
    build:
      context: ./apps/api
    environment:
      <<: *default-env
      CELERY_CONCURRENCY: ${CELERY_CONCURRENCY:-2}
    depends_on: [api, redis, db, minio]
    volumes:
      - ./apps/api:/app
    command: celery -A app.queue worker --loglevel=INFO --concurrency=${CELERY_CONCURRENCY:-2}

  db:
    image: postgres:16
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-codex}
      POSTGRES_USER: ${POSTGRES_USER:-codex}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-codex}
    ports: ["5432:5432"]
    volumes: [ "db_data:/var/lib/postgresql/data" ]

  redis:
    image: redis:7-alpine
    ports: ["6379:6379"]

  minio:
    image: minio/minio:RELEASE.2025-01-11T06-25-06Z
    environment:
      MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minio}
      MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minio12345}
    command: server /data --console-address ":9001"
    volumes: ["minio_data:/data"]
    ports: ["9000:9000","9001:9001"]

  minio-create-bucket:
    image: minio/mc
    depends_on: [minio]
    entrypoint: >
      /bin/sh -c "
      mc alias set local http://minio:9000 ${MINIO_ROOT_USER} ${MINIO_ROOT_PASSWORD} &&
      mc mb -p local/${S3_BUCKET:-codex-suite} || true &&
      mc anonymous set download local/${S3_BUCKET:-codex-suite} || true
      "
    restart: "no"

volumes:
  db_data:
  minio_data:
